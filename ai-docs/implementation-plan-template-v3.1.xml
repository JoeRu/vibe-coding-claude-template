<?xml version="1.0" encoding="UTF-8"?>
<!--
  Implementation Plan Template v3.1

  Usage:
  - Each <item> represents a feature, bug, refactoring, or tech-debt
  - Status flow: BACKLOG → PENDING → APPROVED → IN_PROGRESS → DONE | DENIED
  - Items are sorted by priority and dependency
  - Statistics are derived from items, not manually maintained

  Conventions:
  - IDs are unique integers across all items
  - depends-on references other item IDs (comma-separated)
  - parent attribute references the parent item ID for epics/sub-items
  - All dates in ISO 8601 format (YYYY-MM-DD)

  Complexity guide:
  - S  = isolated change, single file, < 1 day
  - M  = few files, clear scope, 1–3 days
  - L  = cross-cutting, multiple components, 3–7 days
  - XL = epic-level, requires decomposition into sub-items
-->
<implementation-plan>

  <!-- ================================================================== -->
  <!-- PROJECT METADATA                                                    -->
  <!-- ================================================================== -->
  <metadata>
    <title>Project Title</title>
    <version>1.0</version>
    <status>DRAFT|IN_PROGRESS|COMPLETED|ON_HOLD</status>
    <created>2026-01-01</created>
    <updated>2026-01-01</updated>
    <owner>Name or Team</owner>
    <repository>https://github.com/org/repo</repository>
  </metadata>

  <!-- ================================================================== -->
  <!-- GOALS & SCOPE                                                       -->
  <!-- ================================================================== -->
  <goals>
    <goal>What the project aims to achieve</goal>
  </goals>
  <scope>
    <in-scope>What is included</in-scope>
    <out-of-scope>What is explicitly excluded</out-of-scope>
  </scope>

  <!-- ================================================================== -->
  <!-- ARCHITECTURE                                                        -->
  <!-- ================================================================== -->
  <architecture>
    <description>Overall architecture description</description>

    <patterns>
      <pattern>e.g. MVC, Event-Driven, Microservices</pattern>
    </patterns>

    <system-requirements>
      <!-- Runtime, OS, hardware prerequisites -->
      <requirement>e.g. Node.js >= 20, Python >= 3.11</requirement>
    </system-requirements>

    <external-dependencies>
      <!-- APIs, services, third-party tools -->
      <dependency>e.g. Stripe API, PostgreSQL 16, Redis</dependency>
    </external-dependencies>

    <interfaces>
      <interface type="inbound|outbound">Interface description</interface>
    </interfaces>

    <design-decisions>
      <decision date="2026-01-01">Decision description and rationale</decision>
    </design-decisions>
  </architecture>

  <!-- ================================================================== -->
  <!-- ENVIRONMENTS (optional)                                             -->
  <!-- ================================================================== -->
  <environments>
    <environment name="dev">Local development setup notes</environment>
    <environment name="staging">Staging environment details</environment>
    <environment name="prod">Production environment details</environment>
  </environments>

  <!-- ================================================================== -->
  <!-- SECURITY                                                            -->
  <!-- ================================================================== -->
  <security>
    <concern>
      <threat>Threat description</threat>
      <risk>LOW|MEDIUM|HIGH|CRITICAL</risk>
      <vulnerability>Potential vulnerability</vulnerability>
      <mitigation>How it is or will be addressed</mitigation>
    </concern>
  </security>

  <!-- ================================================================== -->
  <!-- MILESTONES (optional)                                               -->
  <!-- ================================================================== -->
  <milestones>
    <milestone id="M1" target-date="2026-03-01">
      <title>Milestone Name</title>
      <items>1, 2, 3</items><!-- references item IDs -->
    </milestone>
  </milestones>

  <!-- ================================================================== -->
  <!-- ITEMS (features, bugs, refactoring, tech-debt)                      -->
  <!-- Sort by: priority DESC, then dependency order                       -->
  <!-- ================================================================== -->

  <!--
    Status lifecycle:

    BACKLOG ──→ PENDING ──→ APPROVED ──→ IN_PROGRESS ──→ DONE
                   │
                   └──→ DENIED

    Attributes:
      type:        feature | bug | refactoring | tech-debt
      status:      BACKLOG | PENDING | APPROVED | IN_PROGRESS | DONE | DENIED
      priority:    CRITICAL | HIGH | MEDIUM | LOW
      complexity:  S | M | L | XL  (optional, see guide above)
      parent:      item ID          (optional, for epic decomposition)
      security:    true              (optional, marks security-relevant items)
      ref-feature: CF-ID             (optional, links [REF] items to completed-features in overview.xml)

    Rules for complex items (XL):
      - An XL item acts as an EPIC and MUST be decomposed into sub-items
      - Sub-items reference the epic via parent="ID"
      - The epic's status is derived from its children:
          ALL children DONE        → epic is DONE
          ANY child IN_PROGRESS    → epic is IN_PROGRESS
          ALL children BACKLOG     → epic is BACKLOG
      - The epic itself holds acceptance-criteria, overall risks, and scope
      - Sub-items hold their own tasks, verification, and results
  -->

  <!-- ================================================================== -->
  <!-- EXAMPLE: Complex Feature (Epic with sub-items)                      -->
  <!-- ================================================================== -->

  <item id="10" type="feature" status="IN_PROGRESS" priority="CRITICAL" complexity="XL">
    <title>User Authentication System</title>
    <branch>feature/auth</branch>
    <justification>Core security requirement for all protected routes</justification>
    <depends-on></depends-on>

    <!-- Acceptance criteria: define "done" for the epic as a whole -->
    <acceptance-criteria>
      <criterion id="AC1">Users can log in via Google and GitHub OAuth</criterion>
      <criterion id="AC2">Sessions expire after 24h of inactivity</criterion>
      <criterion id="AC3">Failed login attempts are rate-limited (max 5/min)</criterion>
      <criterion id="AC4">All auth events are audit-logged</criterion>
    </acceptance-criteria>

    <risks>
      <risk>OAuth provider outages could block all logins → implement fallback email/password flow</risk>
      <risk>Token leakage via XSS → enforce HttpOnly + Secure cookies, add CSP headers</risk>
    </risks>

    <!-- No tasks here – tasks live in sub-items -->
    <!-- No verification here – verification lives in sub-items -->
    <!-- Result is derived from sub-item outcomes -->
    <r>
      <outcome></outcome>
      <observations></observations>
      <lessons-learned></lessons-learned>
    </r>
  </item>

  <!-- Sub-item 1 of Epic 10 -->
  <item id="11" type="feature" status="DONE" priority="CRITICAL" complexity="M" parent="10">
    <title>OAuth2 Provider Integration (Google + GitHub)</title>
    <branch>feature/auth</branch>
    <justification>Implements AC1 of epic 10</justification>
    <depends-on></depends-on>

    <tasks>
      <task id="11.1">Configure OAuth2 app credentials for Google and GitHub</task>
      <task id="11.2">Implement OAuth callback handler with PKCE flow</task>
      <task id="11.3">Map OAuth user profile to internal user model</task>
    </tasks>

    <verification>
      <manual-steps>
        <step order="1">Log in via Google – verify redirect and token creation</step>
        <step order="2">Log in via GitHub – verify redirect and token creation</step>
        <step order="3">Attempt login with revoked OAuth token – verify graceful error</step>
      </manual-steps>
      <tests>
        <test type="integration">
          <file>tests/auth/test_oauth_flow.py</file>
          <description>End-to-end OAuth login with mocked provider</description>
          <assertions>User created in DB, session token returned, redirect to dashboard</assertions>
        </test>
        <test type="unit">
          <file>tests/auth/test_profile_mapping.py</file>
          <description>OAuth profile to internal user model mapping</description>
          <assertions>All required fields populated, missing optional fields default correctly</assertions>
        </test>
      </tests>
    </verification>

    <r>
      <outcome>DONE</outcome>
      <observations>GitHub OAuth requires extra scope for email access</observations>
      <lessons-learned>Always request email scope explicitly – GitHub doesn't include it by default</lessons-learned>
      <files>
        <file>src/auth/oauth.py</file>
        <file>src/auth/profile_mapper.py</file>
        <file>config/oauth_providers.yaml</file>
      </files>
    </r>
  </item>

  <!-- Sub-item 2 of Epic 10 -->
  <item id="12" type="feature" status="APPROVED" priority="HIGH" complexity="M" parent="10">
    <title>Session Management &amp; Token Refresh</title>
    <branch>feature/auth</branch>
    <justification>Implements AC2 of epic 10</justification>
    <depends-on>11</depends-on>

    <tasks>
      <task id="12.1">Implement JWT token issuance with 24h sliding expiry</task>
      <task id="12.2">Add token refresh endpoint</task>
      <task id="12.3">Implement session invalidation on logout</task>
    </tasks>

    <verification>
      <tests>
        <test type="unit">
          <file>tests/auth/test_session.py</file>
          <description>Token expiry and refresh logic</description>
          <assertions>Expired tokens rejected, refreshed tokens valid, logout invalidates session</assertions>
        </test>
        <test type="human">
          <description>Log in, wait 24h (or adjust expiry to 1min for test), verify auto-logout and re-auth prompt</description>
        </test>
      </tests>
    </verification>

    <r>
      <outcome></outcome>
      <files><file></file></files>
    </r>
  </item>

  <!-- ================================================================== -->
  <!-- EXAMPLE: Complex Bug with Analysis Phase                            -->
  <!-- ================================================================== -->

  <item id="20" type="bug" status="IN_PROGRESS" priority="CRITICAL" complexity="L" parent="10">
    <title>Intermittent auth failures under load</title>
    <justification>Affects ~5% of login attempts in production</justification>
    <depends-on>11</depends-on>

    <steps-to-reproduce>
      <step order="1">Run load test with 500 concurrent users against /auth/login</step>
      <step order="2">Observe 401 errors appearing in logs after ~2 minutes</step>
      <step order="3">Errors disappear when concurrency drops below 100</step>
    </steps-to-reproduce>
    <expected-result>All valid sessions authenticate successfully regardless of load</expected-result>

    <!--
      Analysis: use for complex bugs that require investigation.
      - List hypotheses with status OPEN → CONFIRMED | REJECTED
      - Once root cause is identified, record it and define tasks
    -->
    <analysis>
      <hypothesis id="H1" status="CONFIRMED">
        Race condition in token cache: concurrent writes overwrite valid tokens
      </hypothesis>
      <hypothesis id="H2" status="REJECTED">
        Connection pool exhaustion under concurrent requests (pool size verified sufficient)
      </hypothesis>
      <root-cause>H1 – confirmed via thread dump: two threads writing to token cache without synchronization</root-cause>
      <affected-files>
        <file>src/auth/token_cache.py</file>
        <file>src/auth/session_manager.py</file>
      </affected-files>
    </analysis>

    <tasks>
      <task id="20.1">Add mutex lock to token cache write operations</task>
      <task id="20.2">Add load test (500 concurrent) to CI pipeline as regression guard</task>
    </tasks>

    <verification>
      <manual-steps>
        <step order="1">Re-run load test with 500 concurrent users</step>
        <step order="2">Verify zero 401 errors over 10-minute sustained load</step>
      </manual-steps>
      <tests>
        <test type="integration">
          <file>tests/auth/test_concurrent_auth.py</file>
          <description>Concurrent authentication load test</description>
          <assertions>0 auth failures at 500 concurrent users over 10 minutes</assertions>
        </test>
        <test type="unit">
          <file>tests/auth/test_token_cache_threading.py</file>
          <description>Thread-safety of token cache operations</description>
          <assertions>No data corruption with 50 concurrent read/write threads</assertions>
        </test>
      </tests>
    </verification>

    <r>
      <outcome></outcome>
      <files><file></file></files>
    </r>
  </item>

  <!-- ================================================================== -->
  <!-- EXAMPLE: Simple Feature (no parent, straightforward)                -->
  <!-- ================================================================== -->

  <item id="30" type="feature" status="APPROVED" priority="MEDIUM" complexity="S">
    <title>Add health check endpoint</title>
    <branch>feature/healthcheck</branch>
    <justification>Required for Kubernetes liveness probe</justification>
    <depends-on></depends-on>

    <tasks>
      <task id="30.1">Create GET /health endpoint returning 200 + DB connectivity status</task>
    </tasks>

    <verification>
      <tests>
        <test type="unit">
          <file>tests/test_health.py</file>
          <description>Health endpoint returns correct status</description>
          <assertions>Returns 200 with DB up, 503 with DB down</assertions>
        </test>
      </tests>
    </verification>

    <r>
      <outcome></outcome>
      <files><file></file></files>
    </r>
  </item>

  <!-- ================================================================== -->
  <!-- EXAMPLE: Denied item (minimal)                                      -->
  <!-- ================================================================== -->

  <item id="40" type="feature" status="DENIED" priority="LOW">
    <title>Custom theme support</title>
    <justification>Out of scope for MVP – revisit in v2.0</justification>
  </item>

  <!-- ================================================================== -->
  <!-- CHANGELOG – track plan evolution                                    -->
  <!-- ================================================================== -->
  <changelog>
    <entry date="2026-01-01">v3.0 – Initial plan created</entry>
    <entry date="2026-01-15">v3.1 – Added parent/child, acceptance-criteria, analysis, complexity</entry>
  </changelog>

</implementation-plan>
